# FL Repository

The FL Repository is an enabler developed as a part of the [Assist-IoT project](https://assist-iot.eu/). 
It was developed as a part of an FL system along with the FL Orchestrator, FL Local Operations and FL Training Collector in order to provide centralized storage to the FL process. It allows for the storage of reusable components for the future FL training processes, such as ML models, FL aggregation strategies and data transformations, as well as enables the FL Training Collector to safely store the results of the FL training (metadata plus pickled model weights).

## Helm chart

The FL Repository enabler has been developed with the assumption that it will be deployed on Kubernetes with a dedicated Helm chart. To do so, just run `helm install <deployment name> helm-chart`. To make sure that before that the enabler has been configured properly, check if the values in the `repository-configmap` have been properly set (to change them, you can always modify the configmap with `kubectl edit cm repository-configmap` and then recreate the FL Repository pod to propagate the changes). 

By default, the chart also uses the host's ports `30001` as a Node Port. Other port may also be used, but they will have to be explicitely changed in the `values.yaml` file/ Kubernetes service. You can also set there the specific NodePort you would like to use to reach the FL Repository API by changing the values in the flrepository service.  

If you'd like to see and experiment with the API, the recommended approach is to go to the http://127.0.0.1:XXXXX/docs URL, where XXXXX stands for the flrepository service NodePort, and use the Swagger docs generated by the FastAPI framework.

## Docker image

Run `docker-compose -f docker-compose.yml up --force-recreate --build -d` in the root of this repository to build a custom image to be used by the FL Repository.

### Serializing and deserializing the database

If you want for the MongoDB database on your custom repositorydb image to initialize with some of the preexisting objects already stored in the collections, you can achieve that by:
1. Use the API to add and subtract the objects in the database until it has the desired content.
2. Use the `kubectl exec -i -t <podname> -- /bin/bash` command to reach the commandline of the repositorydb pod.
3. Use the `mongodump --archive db.dump` tool with the appropriate options to create the backup file.
4. Use `kubectl cp <podname>:/db.dump .db.dump` to move the archive file from the pod to the repository.
5. Move the db.dump file to the mongo_db directory.
6. Run the `docker-compose -f docker-compose.yml up --force-recreate --build -d` command to construct the right image.


## API endpoints and relevant collections

### ML Models

The models as a collection contain the information about machine learning models ready and available for FL training. This means the relevant metadata (the model name and version, which enables the user to effectively distinguish between models; the library, which indicates whether the model is ready for training using the FL LO Pytorch local client or Keras local client; and the description, which contains a couple of words describing the architecture of a potential model). For example:

```json
{
    "meta": {
      "library": "keras",
      "description": "A CNN (Convolutional Neural Network) designed to solve the CIFAR-10 image classification task. Used as a test model for the development of the Keras library."
    },
    "model_name": "base",
    "model_version": "base2",
    "model_id": "62aae16f6ee3b61c9c6c2921"
  }
```

The models collection can be manipulating using the following endpoints:

- **POST /model**	
  Adds the metadata of a new initial model to the library.
- **PUT	/model/{name}/{version}**	
  Depending on whether a model with a given name and version exists in the FL Repository, its object file is created or updated. 
- **PUT	/model/meta/{name}/{version}**	
  For the given model name and version its metadata is updated.
- **GET	/model**	
  Return the list encompassing the metadata of all available models.
- **GET	/model/meta**	
  Return the metadata of the model with a given name and version.
- **GET	/model/{name}/{version}**	
  Return the binary file containing the final model weights and structure.
- **DELETE	/model/{name}/{version}**	
  Delete the metadata and binary file of a model with a given name and version.
- **GET	/models/available**	
  Return the list encompassing the metadata of all available models, sorted by their upload date.
- **GET	/models/download/shell/{filename}**	
  Download the binary files containing the model weights and structure for all available models, sorted by their upload date.

More information about the construction and upload of new models, along with a quick tutorial on how to update the ML Model with the selected training results will be found in the documentation of the FL Local Operations.

### ML Training Results  

The training results as a collection contain the information about the FL training processes that have been conducted, along with the results of that training in the form of pickled final model weights (the decision of saving only the weights was motivated by the desire to minimize the space consumption of the collection). This means the relevant metadata (the model name and version, which enables the user to effectively distinguish between models; the id of the training and the configuration used for that training; the metrics achieved throughout the training, as described more in depth in the FL Training Collector documentation). For example:

```json
{
    "model_name": "keras_test",
    "model_version": "version_1",
    "training_id": "12",
    "results": {
      "rounds": "3",
      "final_loss": "78.94696807861328",
      "accuracy": "0.21299999952316284",
      "min_fit_clients": "1",
      "min_evaluate_clients": "1",
      "min_available_clients": "1"
    },
    "weights_id": "652838994e96467edfe72a9a",
    "configuration_id": "10"
}
```
The training results collection can be manipulating using the following endpoints:

- **POST /training-results**	
  Upload new training results (including final model weights and metadata containing aggregated metrics and configuration) for a given model_name, model_version, training_id and configuration_id.
- **GET	/training-results**	
  Get the list with the metadata of all training results available in this FL Repository instance.
- **GET	/training-results/{name}/{version}**	
  Get the list with the metadata of all training results available in this FL Repository instance for a given model name and version.
- **PUT	/training-results/{name}/{version}/{training-id}/{configuration-id}**	
  Update the final training weights of a given training results instance. 
- **GET	/training-results/weights/{name}/{version}/{training-id}**	
  Return the final weights achieved as a result of a training.
- **DELETE /training-results/{name}/{version}/{training-id}**	
  Delete the selected training results (the weights along with the metadata).

More information about the format of the training results sent from the FL Training Collector and how to use them to update the weights of a given FL model can be found in the documentation of the FL Local Operations and of the FL Training Collector.

### FL Strategies

The strategies as a collection contain the information about the available FL aggregation strategies along with their serialized objects. The relevant metadata here contains the unique name of the strategy and a short strategy description. For example:

```json
{
    "meta": {
    },
    "strategy_name": "fault-tolerant-fedavg",
    "strategy_description": "A fault tolerant version of FedAvg",
    "strategy_id": "632b8668657188818260a056"
}
```

The aggregation strategy collection can be manipulating using the following endpoints:

- **POST /strategy**	
  Create a new aggregation strategy with the specified metadata.
- **PUT	/strategy/{name}**	
  Update the object file for the aggregation strategy with a given name.
- **PUT	/strategy/meta/{name}**	
  Update the metadata for the aggregation strategy with a given name.
- **GET	/strategy**	
  Get the metadata of all available aggregation strategies in the form of a list.
- **GET	/strategy/{name}**	
  Get the object file of the aggregation strategy with a given name.
- **DELETE	/strategy/{name}**	
  Delete the aggregation strategy of a given name.

More information about the format of the aggregation strategies that can be used by the FL Training Collector and how to add new ones can be found in the documentation of the FL Training Collector.

### ML Data Transformations

The data transformations as a collection contain the information about the available FL data transformations, which can be  along with their serialized objects. The relevant metadata here contains the unique id of the data transformation, a short description on its purpose, the parameters and parameter types that it expects to obtain, the default values of those parameters, the data types that it outputs and the system needs that it has, like the preinstalled libraries or models, the amount of extra storage that is requires, along with the amount of RAM and the potential availability of a GPU. For example:

```json
{
    "id": "application.tests.categorical_transformation",
    "description": "This class transforms y data into categorical data",
    "parameter_types": {
      "categories": "int"
    },
    "default_values": {
      "categories": 10
    },
    "outputs": [
      "np.ndarray",
      "np.ndarray"
    ],
    "needs": {
      "storage": 0,
      "RAM": 0,
      "GPU": false,
      "preinstalled_libraries": {},
      "available_models": {}
    }
  }
```

The data transformations collection can be manipulating using the following endpoints:

- **POST /transformation**	
  Create a new data transformation with the specified metadata.
- **PUT	/transformation/{id}**	
  Update the object file for a given data transformation.
- **PUT	/transformation/meta/{id}**	
  Update the metadata of a given data transformation.
- **GET	/transformation**	
  Get the list with the metadata of all data transformations available in this FL Repository instance.
- **GET	/transformation/{id}**	
  Get the object file of a data transformation with a given id.
- **DELETE	/transformation/{id}**	
  Delete the metadata and the object file of a data transformation with a given id.

More information about how to construct, connect and reuse data transformations can be found in the documentation of the FL Local Operations.

## Authors

- Karolina Bogacka
- Katarzyna Wasielewska-Michniewska

## Licensing

The FL Repository is released under the Apache 2.0 license, as we have internally concluded that we are not "offering the functionality of MongoDB, or modified versions of MongoDB, to third parties as a service". However, potential future commercial adopters should be aware that our project uses MongoDB in order to be able to accurately determine the license most applicable to their projects. 

## Additional documentation

The extended or apprioprately modified documentation will be possible to find [here](https://assist-iot-enablers-documentation.readthedocs.io/en/latest/verticals/federated/fl_repository.html).

